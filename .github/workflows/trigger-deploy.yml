name: Trigger deploy after merges to main 

on: 
  push:
    branches: [main]

jobs:
  merge-commits-trigger-deploy:
    runs-on: ubuntu-latest
    permissions:
      actions: write # be able to trigger another workflow 
      contents: write # to merge commits into latest branch 
    steps:
    - uses: actions/checkout@v3

    - name: Copy commits into latest branch 
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git checkout -b latest
        git rebase main
        git push origin latest          
    
    # We manually run here because github will not execute github actions as a result of commits being pushed to latest branch. 
    - name: Trigger deploy 
      uses: aurelien-baudet/workflow-dispatch@v2
      id: deploy-action
      with:
        workflow: deploy-action.yml
        wait-for-completion: true
        ref: latest # run the workflow on latest branch so deploy happens on it. 
        token: ${{ secrets.GITHUB_TOKEN }}        

    - name: Fail if deploy was not successful 
      if: ${{ steps.deploy-action.outputs.workflow-conclusion != 'success' }}
      uses: cutenode/action-always-fail@v1.0.0